<?php
class user extends spController{
	public function __construct(){
		parent::__construct();
		$this->ucenter = spClass('spUcenter');
		$this->users = spClass("m_u");
		$this->ggw = spClass("m_ggw");
		if($_SESSION['user'])
			$this->uname = $_SESSION['user'];
		if($this->uname){
			if(!$this->users->find(array('username'=>$this->uname)))
				$this->users->create(array('username'=>$this->uname,'lastlogin'=>date("Y-m-d H:i:s")));
		}
	}
	public function register(){
		$this->registersuccess = 0;
		if($this->spArgs("submit")){
			$username = $this->spArgs("username");
			$password = $this->spArgs("password");
			$email = $this->spArgs("email");
			$questionid = $this->spArgs("questionid");
			$answer = $this->spArgs("answer");
			$uid = $this->ucenter->uc_user_register($username,$password,$email);
			if($uid <= 0){
				if($uid == -1){
					$this->regnote = '注册失败：用户名不合法';
				}elseif($uid == -2){
					$this->regnote = '注册失败：包含要允许注册的词语';
				}elseif($uid == -3){
					$this->regnote = '注册失败：用户名已经存在';
				}elseif($uid == -4){
					$this->regnote = '注册失败：Email 格式有误';
				}elseif($uid == -5){
					$this->regnote = '注册失败：Email 不允许注册';
				}elseif($uid == -6){
					$this->regnote = '注册失败：该 Email 已经被注册';
				}else{
					$this->regnote = '注册失败：未定义';
				}
			}else{
				$this->registersuccess = 1;
				$this->regnote = '注册成功!!';
			}
				
		}
	}
	public function login(){
		/* 设置签名 */
		$app_key = '21726073';/*填写appkey */
		$secret='c23972d5f868ce97b17e66298a228136';/*填入Appsecret'*/
		$timestamp=time()."000";
		$message = $secret.'app_key'.$app_key.'timestamp'.$timestamp.$secret;
		$mysign=strtoupper(hash_hmac("md5",$message,$secret));
		setcookie("timestamp",$timestamp);
		setcookie("sign",$mysign);
		/*  END - 设置签名*/
		$loginstatus = $this->spArgs('cmd');
		if($loginstatus == 'out'){
			$_SESSION['user'] = 0;
			header("Location:/?c=user&a=login");
		}elseif($loginstatus == 'reg'){
			$this->register();
		}else{
			if($this->spArgs("submit")){
				$username = $this->spArgs("username");
				$password = $this->spArgs("password");
				$email = $this->spArgs("email");
				$questionid = $this->spArgs("questionid");
				$answer = $this->spArgs("answer");
				$userinfo = $this->ucenter->uc_user_login($username,$password,$email);
				$uid = $userinfo[0];
				$uname = $userinfo[1];
				//var_dump($userinfo);
				if($uid > 0) {
					$this->loginsuccess = 1;
					$userinfo = $this->ucenter->uc_get_user($username);
					$_SESSION['user'] = $uname;
					$this->loginnote = '登录成功';
				} elseif($uid == -1) {
					$this->loginnote = '用户不存在,或者被删除';
				} elseif($uid == -2) {
					$this->loginnote = '密码错误';
				} else {
					$this->loginnote = '未定义';
				}
			}
		}
		if($_SESSION['user']){
			$this->users->update(array('username'=>$_SESSION['user']),array('lastlogin'=>date("Y-m-d H:i:s")));
			header("Location:/?c=user&a=iinfo");
		}
		$this->cmd = $loginstatus;
		$this->display("front/login.html");
	}
	public function iinfo(){
		if(!$_SESSION['user'])
			header("Location:/?c=user&a=login");
		//echo $_SESSION['user'];
		$act = $this->spArgs("act");
		$this->act = $act;
		$uinfo = $this->users->find(array('username'=>$this->uname));
		$this->lastlogin = $uinfo['lastlogin'];
		$this->ww = $uinfo['ww'];
		$this->hyjf = $uinfo['hyjf'];
		$this->ggws = $this->ggw->findAll(array('username'=>$this->uname));
		//var_dump($this->ggws);
		if($this->spArgs("submit")){
			$ww = $this->spArgs("ww");
			$iid = $this->spArgs("iid");
			if($ww)
				$this->users->update(array('username'=>$this->uname),array('ww'=>$ww));
			if($iid){
				if($this->hyjf>=900){
					$this->ggw->create(array('username'=>$this->uname,'iid'=>$iid,'dh'=>1));
					$this->users->update(array('username'=>$this->uname),array('hyjf'=>$this->hyjf-900));
				}
			}
		}
		
		$uinfo = $this->ucenter->uc_get_user($_SESSION['user']);
		$this->uemail = $uinfo[2];//var_dump($uinfo);
		$this->display("front/iinfo.html");
	}
	
}